<!DOCTYPE html>
<style></style>
<div id="a">
  <div id="b">
    <h1>H1</h1>
  </div>
</div>
<script type="module">
  import { doubleRaf, testSuite, assert } from "./test-utils.js";
  import { transpileStyleSheet } from "/cqfill.js";

  testSuite("Manual transpiling", async () => {
    const parsed = transpileStyleSheet(`
      #a {
        outline: 1px solid red;
        container-name: a;
        height: 150px;
        resize: both;
        overflow: auto;
        container-type: size;
      }
      #b {
        outline: 1px solid blue;
        container-name: b;
        height: 140px;
        resize: both;
        overflow: auto;
        container-type: size;
      }
      h1 {
        font-size: 10px;
        line-height: 10px;
      }
      @container (min-width: 200px) {
        h1 {
          font-size: 30px;
        }
      }
      @container (max-width: 200px) {
        h1 {
          font-size: 20px;
        }
      }
      @container a (max-width: 300px) {
        h1 {
          line-height: 40px;
        }
      }
      @container a (min-width: 300px) {
        h1 {
          line-height: 30px
        }
      }
    `);
    document.querySelector("style").innerHTML = parsed;

    const a = document.querySelector("#a");
    const b = document.querySelector("#b");
    const configs = [
      {
        aWidth: 250,
        bWidth: 150,
        expectedLineHeight: "30px",
        expectedFontSize: "20px",
      },
      {
        aWidth: 250,
        bWidth: 250,
        expectedLineHeight: "30px",
        expectedFontSize: "30px",
      },
      {
        aWidth: 350,
        bWidth: 150,
        expectedLineHeight: "40px",
        expectedFontSize: "20px",
      },
      {
        aWidth: 350,
        bWidth: 250,
        expectedLineHeight: "40px",
        expectedFontSize: "30px",
      },
    ];
    for (const {
      aWidth,
      bWidth,
      expectedFontSize,
      expectedLineHeight,
    } of configs) {
      a.style = `width: ${aWidth}px`;
      b.style = `width: ${bWidth}px`;
      await doubleRaf();
      const { fontSize, lineHeight } = getComputedStyle(
        document.querySelector("h1")
      );
      assert(
        fontSize === expectedFontSize,
        `Expected line-height to be ${expectedFontSize}, got ${fontSize}`
      );
      assert(
        lineHeight === expectedLineHeight,
        `Expected font-size to be ${expectedLineHeight}, got ${lineHeight}`
      );
    }
  });
</script>
